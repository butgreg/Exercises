version: '3.8'

networks:
  lan_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.10.0/24
          gateway: 192.168.10.254
  vlan1:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.20.0/24
          gateway: 192.168.20.254
  vlan2:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.30.0/24
          gateway: 192.168.30.254
  wan_network:
    driver: bridge
    ipam:
      config:
        - subnet: 203.0.113.0/24
          gateway: 203.0.113.254

services:
  router:
    image: alpine
    container_name: router
    privileged: true
    cap_add:
      - NET_ADMIN
    networks:
      lan_network:
        ipv4_address: 192.168.10.1
      vlan1:
        ipv4_address: 192.168.20.1
      vlan2:
        ipv4_address: 192.168.30.1
      wan_network:
        ipv4_address: 203.0.113.1
    command: sh -c "
      apk add --no-cache bird iproute2 &&
      bird -c /etc/bird/bird.conf -d" &&
      tail -f /dev/null
    volumes:
      - ./config/bird.conf:/etc/bird/bird.conf
    restart: always  # Ensures the container restarts if it stops

  dns_server:
    image: andyshinn/dnsmasq
    container_name: dns_server
    cap_add:
      - NET_ADMIN
    networks:
      lan_network:
        ipv4_address: 192.168.10.53
    volumes:
    - ./config/dnsmasq.conf:/etc/dnsmasq.conf
    entrypoint: ["dnsmasq", "--conf-file=/etc/dnsmasq.conf", "--no-daemon"]
    restart: always  # Ensures the container restarts if it stops

  linux_server:
    image: ubuntu
    container_name: linux_server
    networks:
      lan_network:
        ipv4_address: 192.168.10.5
    environment:
      - APACHE_SERVER_NAME=192.168.10.5:80
    command: bash -c "apt-get update &&
      apt-get install -y iperf3 tcpdump netcat-traditional apache2 iproute2 &&
      echo 'ServerName 192.168.10.5:80' >> /etc/apache2/apache2.conf &&
      apache2ctl start &&
      tail -f /dev/null"
    restart: always  # Ensures the container restarts if it stops


  linux_client1:
    image: kalilinux/kali-rolling
    container_name: linux_client1
    environment:
      - DEBIAN_FRONTEND=noninteractive
    networks:
      lan_network:
        ipv4_address: 192.168.10.100
    cap_add:
    - NET_ADMIN
    command: bash -c "
      apt-get update &&
      apt-get install -y sudo iproute2 netcat-traditional apt-utils \
      tcpdump nmap dnsutils traceroute wireshark tshark iperf3 net-tools \
      arp-scan openssh-server &&
      useradd -m -s /bin/bash user &&
      echo 'user:practicalexercise' | chpasswd &&
      echo 'user ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers &&
      mkdir -p /var/run/sshd &&
      /usr/sbin/sshd -D &&
      bash"

  linux_client2:
    image: kalilinux/kali-rolling
    container_name: linux_client2
    networks:
      vlan1:
        ipv4_address: 192.168.20.100
    cap_add:
      - NET_ADMIN
    command: bash -c "
      apt-get update &&
      apt-get install -y iproute2 &&
      tail -f /dev/null"

  traffic_gen1:
    image: networkstatic/iperf3
    container_name: traffic_gen1
    networks:
      lan_network:
        ipv4_address: 192.168.10.101
    cap_add:
      - NET_ADMIN
    entrypoint: sh -c "
      sleep 10 &&
      while true; do
        iperf3 -c traffic_gen_server;
        sleep 5;
      done"

  traffic_gen2:
    build:
      context: .
    container_name: traffic_gen2
    networks:
      vlan1:
        ipv4_address: 192.168.20.101
    cap_add:
      - NET_ADMIN
      - NET_RAW
    entrypoint: sh -c "
      sleep 10 &&
      while true; do
        iperf3 -c 192.168.10.4;
        sleep 5;
      done"
        
  traffic_gen_server:
    image: networkstatic/iperf3
    container_name: traffic_gen_server
    networks:
      lan_network:
        ipv4_address: 192.168.10.201
    command: -s
    restart: always  # Ensures the container restarts if it stops

  syslog:
    image: lscr.io/linuxserver/syslog-ng:latest
    container_name: syslog
    networks:
      lan_network:
        ipv4_address: 192.168.10.250

  unauthorized_device:
    image: alpine
    container_name: unauthorized_device
    networks:
      lan_network:
        ipv4_address: 192.168.10.80
    cap_add:
      - NET_ADMIN
      - NET_RAW
    entrypoint: sh -c "sleep 60 && 
      ip addr add 192.168.10.100/24 dev eth0 &&
      echo 'Simulating unauthorized device with conflicting IP...' &&
      sleep infinity"
    restart: always  # Ensures the container restarts if it stops
